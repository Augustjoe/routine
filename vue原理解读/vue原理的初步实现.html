<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="root">
        <div>{{name}}</div>
        <div>{{age}}</div>
        <div>{{sex}}</div>
        <ul>
            <li>{{one}}</li>
            <li>{{two}}</li>
            <li>{{thirts}}</li>
            <li>{{four}}</li>
        </ul>
    </div>
</body>
</html>
<script>
    class VNode{
        // tag 标签名称 data标签属性 value 标签内的值 type 是文本还是标签
        constructor( tag, data, value, type ){
            this.tag = tag;
            this.data = data;
            this.value = value;
            this.type = type;
            //用来存放子节点
            this.children = [ ];
        }
        appendChild( vnode ){
            this.children.push(vnode);
        }
    }
    //生成虚拟DOM
    function getVNode(node){
        //先将存储虚拟dom的值设空
        let _vnode = null
        if(node.nodeType === 1){
            //标签
            let nodeName = node.nodeName
            let arrts = node.attributes
            let attrObj = {};
            for(let i = 0;i<arrts.length;i++){
                attrObj[arrts[i].nodeName] = arrts[i].nodeValue;
            }
            _vnode =new VNode(nodeName, attrObj, undefined, node.nodeType)

            for(let i = 0;i<node.childNodes.length;i++){
                _vnode.appendChild( getVNode(node.childNodes[i]))
            }
        }else if(node.nodeType === 3){
            _vnode =new VNode(undefined, undefined, node.nodeValue, node.nodeType)
        }
        return _vnode
    }
    //多层级匹配
    function getPath(path,obj){
        let paths = path.split('.')
        
            let prop;
            let res = obj;
            while(prop = paths.shift()){
                res = res[prop];
            }
            return res;
        
    }
    //将模板和传进的数据进行匹配，生成更新后的虚拟DOM
    function combine(vnode,data){
        let ref = /\{\{(.+?)\}\}/g;
        let _type = vnode.type
        let _tag = vnode.tag
        let _value = vnode.value
        let _data = vnode.data
        let _children = vnode.children
        
        let _vnode = null;
        
        
        if(_type === 3 ){  //文本节点
            _value = _value.replace( ref, function(_, _g){
               return getPath(_g.trim(),data)
            } )

            _vnode = new VNode(_tag,_data,_value,_type) 

        }else if(_type === 1 ){

            _vnode = new VNode(_tag,_data,_value,_type) 
            
            _children.forEach(item => {
                _vnode.appendChild(combine(item,data))
            })
        }
        return _vnode;
    }
    //将虚拟DOM变成真正的DOM
    function parseVNode(node){
        let _node = null;
        if(node.type === 3){
            return document.createTextNode(node.value)
        }else if(node.type === 1){
            _node = document.createElement(node.tag)
            Object.keys(node.data).forEach((item)=>{
               _node.setAttribute( item,node.data[item])
            })
            node.children && node.children.forEach((ele)=>{
                _node.appendChild(parseVNode(ele))
            })
            return _node;
        }
    }
    
    
    function JGvue(options){
        this._data = options.data
        this._el = document.querySelector(options.el) //DOM
        this._parentNode = this._el.parentNode
        this.mount(); //挂载
    }

    JGvue.prototype.mount = function(){
        //生成虚拟DOm
        
        this.render = this.createRenderFn()
        
        this.mountComponant()
    }

    JGvue.prototype.mountComponant = function(){
        let mount = ()=>{
            this.update( this.render() )

        }
        mount.call( this )
    }
    //生成抽象语法树，缓存DOM
    JGvue.prototype.createRenderFn = function(){
        let ast = getVNode(this._el)
        return function render (){
            
            let _temp = combine(ast ,this._data)
            return _temp
        }
    }

    //将虚拟dom渲染到页面中，diff算法在此
    JGvue.prototype.update = function( vnode ){
        let realDom = parseVNode(vnode);
        console.log(realDom)
        this._parentNode.replaceChild(realDom,document.querySelector('#root'))
    }

    let app = new JGvue({
        el:'#root',
        data:{
            name:'张',
            age:18,
            sex:'男',
            one:1,
            two:2,
            thirts:3,
            four:4,

        }
    })
</script>